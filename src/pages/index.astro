---
import "../styles/global.css";
import Layout from "../components/Layout.astro";
import UploadModal from "../components/UploadModal.astro";
import File from "@lucide/astro/icons/file";
import Download from "@lucide/astro/icons/download";
import { db } from "../../db/index";
import { uploads } from "../../db/schema";
const uploadStatus = Astro.url.searchParams.get("upload");

// Query all uploads, newest first
const files = (
  await db
    .select()
    .from(uploads)
    .orderBy((u) => u.uploaded_at)
).reverse();

// Helper to check if a file is an image
function isImage(filename: string) {
  return /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(filename);
}

let modalOpen = false;
function openModal() {
  modalOpen = true;
}
function closeModal() {
  modalOpen = false;
}
function handleUpload() {
  closeModal();
}
---

<Layout onUploadClick={openModal}>
  <UploadModal open={modalOpen} onClose={closeModal} onUpload={handleUpload} />
  <h1 class="text-4xl font-bold mb-8 text-blue-700 mt-8">Astro Asset Upload</h1>
  {
    uploadStatus === "success" && (
      <p class="mb-4 px-4 py-2 rounded bg-green-100 text-green-800 border border-green-300">
        File uploaded successfully!
      </p>
    )
  }
  {
    uploadStatus === "error" && (
      <p class="mb-4 px-4 py-2 rounded bg-red-100 text-red-800 border border-red-300">
        Failed to upload file.
      </p>
    )
  }
  <section class="mt-10 w-full max-w-2xl">
    <h2 class="text-2xl font-semibold mb-4">Uploaded Files</h2>
    <ul class="space-y-4">
      {
        files.length === 0 && (
          <li class="text-gray-500">No files uploaded yet.</li>
        )
      }
      {
        files.map((file) => (
          <li class="flex items-center gap-4 bg-white p-4 rounded shadow border border-gray-200">
            {isImage(file.filename) ? (
              <img
                src={`/api/upload/${file.blob_key}`}
                alt={file.filename}
                class="w-16 h-16 object-cover rounded"
              />
            ) : (
              <span class="w-16 h-16 flex items-center justify-center bg-gray-100 rounded text-gray-400">
                <File class="w-8 h-8" />
              </span>
            )}
            <div>
              <div class="font-medium">{file.filename}</div>
              <div class="text-xs text-gray-500">
                Uploaded at {new Date(file.uploaded_at).toLocaleString()}
              </div>
              <a
                href={`/api/download/${file.blob_key}`}
                download
                class="inline-flex items-center gap-1 mt-2 text-blue-700 hover:underline text-sm font-medium transition">
                <Download size={16} /> Download
              </a>
            </div>
          </li>
        ))
      }
    </ul>
  </section>
</Layout>
